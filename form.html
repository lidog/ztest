<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<div th:fragment="form">
    <script type="text/javascript" src="../../../jquery/autocompleter/jquery.autocompleter.js"></script>
    <link rel="stylesheet" type="text/css" href="../../../jquery/autocompleter/autocompleter.css"/>

    <div id="tab"  class="section-content form-horizontal" style="margin-top:20px;">
        <ul id="myTab" class="nav nav-tabs">
            <li id="shenQLi"  class="active"><a href="#applicationForm" data-toggle="tab">申请单</a></li>
            <li id="chanPLi"><a href="#productDetails" data-toggle="tab">产品详情</a></li>
            <li id="JueYLi" th:if="${DATA_CURRENT_ACTIVITY_ID.equals('13')||DATA_DOCUMENT_DATA.keySet().contains('resolution')}"><a href="#resolution" data-toggle="tab">申请决议</a></li>
        </ul>
        <div class="tab-content" style="margin-top:10px">
            <div role="tabpanel" class="tab-pane active" id="applicationForm">
                <div th:if="${DATA_DOCUMENT_MODE.equals('draft')||DATA_CURRENT_ACTIVITY_ID.equals('26') and !DATA_DOCUMENT_MODE.equals('view')}">
                    <div th:substituteby="document/OA-1057/edit_applicationForm :: edit"></div>
                </div>
                <div th:if="${DATA_DOCUMENT_MODE.equals('process') and !DATA_CURRENT_ACTIVITY_ID.equals('26')||DATA_DOCUMENT_MODE.equals('view')}">
                    <div th:substituteby="document/OA-1057/view_applicationForm :: view"></div>
                    <!-- <div th:substituteby="document/OA-1057/edit_applicationForm :: edit"></div>-->
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="productDetails">
                <div th:if="${DATA_DOCUMENT_MODE.equals('draft')||DATA_CURRENT_ACTIVITY_ID.equals('26') and !DATA_DOCUMENT_MODE.equals('view')}">
                    <div th:substituteby="document/OA-1057/edit_productDetails :: edit"></div>
                </div>
                <div th:if="${DATA_DOCUMENT_MODE.equals('process') and !DATA_CURRENT_ACTIVITY_ID.equals('26')||DATA_DOCUMENT_MODE.equals('view')}">
                    <div th:substituteby="document/OA-1057/view_productDetails :: view"></div>
                    <!-- <div th:substituteby="document/OA-1057/edit_productDetails :: edit"></div>-->
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="resolution">
                <div th:if="${DATA_CURRENT_ACTIVITY_ID.equals('13') and !DATA_DOCUMENT_MODE.equals('view')||DATA_CURRENT_ACTIVITY_ID.equals('15') and !DATA_DOCUMENT_MODE.equals('view')||DATA_CURRENT_ACTIVITY_ID.equals('17') and !DATA_DOCUMENT_MODE.equals('view')||DATA_CURRENT_ACTIVITY_ID.equals('23') and !DATA_DOCUMENT_MODE.equals('view')||DATA_CURRENT_ACTIVITY_ID.equals('37') and !DATA_DOCUMENT_MODE.equals('view')}">
                    <div th:substituteby="document/OA-1057/edit_resolution :: edit"></div>
                </div>
                <!-- <div th:if="${!DATA_CURRENT_ACTIVITY_ID.equals('13') and !DATA_CURRENT_ACTIVITY_ID.equals('15') and !DATA_CURRENT_ACTIVITY_ID.equals('17') and !DATA_CURRENT_ACTIVITY_ID.equals('23') and !DATA_CURRENT_ACTIVITY_ID.equals('37')}">-->
                <div th:if="${DATA_DOCUMENT_MODE.equals('process') and DATA_DOCUMENT_DATA.keySet().contains('resolution') and !DATA_CURRENT_ACTIVITY_ID.equals('13') and !DATA_CURRENT_ACTIVITY_ID.equals('15') and !DATA_CURRENT_ACTIVITY_ID.equals('17') and !DATA_CURRENT_ACTIVITY_ID.equals('23') and !DATA_CURRENT_ACTIVITY_ID.equals('37')||DATA_DOCUMENT_MODE.equals('view') and DATA_DOCUMENT_DATA.keySet().contains('resolution')}">
                    <div th:substituteby="document/OA-1057/view_resolution :: view"></div>
                </div>
                <!--</div>-->
            </div>
        </div>
    </div>


    <div class="section-content form-horizontal" id="scoreDiv" style="margin-top:20px;">
        <div th:if="${!'draft'.equals(DATA_DOCUMENT.status)}">
            <div th:if="${DATA_CURRENT_ACTIVITY_ID.equals('12')||!''.equals(DATA_DOCUMENT_DATA.score)}">
                <div  th:if="${'1'.equals(DATA_DOCUMENT_DATA.requisition.fppType)||'3'.equals(DATA_DOCUMENT_DATA.requisition.fppType)}">
                    <div th:substituteby='document/OA-1057/ratingScale :: scoreTableForm2'></div>
                </div>
                <div  th:if="${'2'.equals(DATA_DOCUMENT_DATA.requisition.fppType)}">
                    <div th:substituteby='document/OA-1057/ratingScale :: scoreTableForm1'></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section-content form-horizontal" id="score27Div" style="margin-top:20px;">
        <div th:if="${!'draft'.equals(DATA_DOCUMENT.status)}">
            <div th:if="${DATA_CURRENT_ACTIVITY_ID.equals('27') || !''.equals(DATA_DOCUMENT_DATA.score27Data)}">
                <div th:substituteby="document/OA-1057/score27View :: score27FormA"></div>
            </div>
        </div>
    </div>

    <div class="section-content form-horizontal" style="margin-top:20px;">
        <div th:if="${DATA_CURRENT_ACTIVITY_ID.equals('17')||DATA_CURRENT_ACTIVITY_ID.equals('23')||DATA_DOCUMENT_MODE.equals('view') and DATA_CURRENT_ACTIVITY_ID.equals('') and DATA_DOCUMENT.status.equals('closed')||DATA_DOCUMENT.status.equals('end')}">
            <div class="section" id="fppdiv">
                <div class="title">推送数据</div>
                <div class="section-content">
                    <div class="row clearfix mt10">
                        <div class="col-sm-2 col-md-2 column bold mt5 mb-label">是否要推送数据</div>
                        <div class="col-sm-8 col-md-8 column">
                            <label class="radio-inline"><input type="radio" id="isPushdata" name="isPushdata"
                                                               value="1"/><span>是</span></label>
                            <label class="radio-inline"><input type="radio" name="isPushdata" value="0"/><span>否</span></label>
                        </div>
                        <div class="col-sm-2 col-md-2 column">
                            <button th:if="${'closed'.equals(DATA_DOCUMENT.status)}" type="button" style="float: right"
                                    class="btn btn-primary " onclick="showPushResult();">
                                查看结果
                            </button>
                            <!--<div class="modal fade" id="myPushResultModal" tabindex="-1" role="dialog"
                                 aria-labelledby="myModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal"
                                                    aria-hidden="true">&times;</button>
                                            <h4 class="modal-title" id="myModalLabel">推送结果</h4>
                                        </div>
                                        <div class="modal-body">
                                            <ul class="list-group" style="max-height:500px;overflow:auto;_height:expression(this.scrollHeight > 500 ? '500px' : auto);"></ul>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                                            </button>
                                            &lt;!&ndash; <button type="button" class="btn btn-primary">Save changes</button>&ndash;&gt;

                                        </div>
                                    </div>
                                </div>
                            </div>-->
                        </div>
                    </div>
                </div>
            </div>
            <!--<div class="section" id="fppImportdiv">
                <div class="title">导入公示</div>
                <div class="section-content">
                    <div class="row clearfix mt10">
                        <div class="col-sm-2 col-md-2 column bold mt5 mb-label">是否导入公示</div>
                        <div class="col-sm-8 col-md-8 column">
                            <label class="radio-inline"><input type="radio" id="isImprotPublicity" name="isImprotPublicity"
                                                               value="1" onclick="isImportPublicityClick(this)"/><span>是</span></label>
                            <label class="radio-inline"><input type="radio" name="isImprotPublicity" value="0"/><span>否</span></label>
                        </div>
                        <div class="col-sm-2 col-md-2 column" id="showImportPublicity" name="showImportPublicity" style="display: none;">
                            <button type="button" style="float: right"
                                    class="btn btn-primary " onclick="showImportPublicityResult();">
                                查看公示附件
                            </button>

                        </div>
                    </div>
                </div>
            </div>-->
        </div>
    </div>

    <!--推送结果的modal-->
    <script id="myPushResultModal-table-template" type="text/x-handlebars-template" th:inline="javascript">
        <div class="modal-body">
            <ul class="list-group" style="max-height:500px;overflow:auto;_height:expression(this.scrollHeight > 500 ? '500px' : auto);"></ul>
        </div>
    </script>
    <!--导入公示的modal-->
    <!--<script id="publicityModal-table-template" type="text/x-handlebars-template" th:inline="javascript">
        <ul id="publicityTree" class="ztree">
        </ul>
    </script>-->
    <!--<div style="display: none;" id="showTree">
        <ul id="publicityTree" class="ztree">
        </ul>
    </div>-->

    <!--    <div class="section-content form-horizontal"  style="margin-top:20px;" th:if="${DATA_DOCUMENT_MODE.equals('view')}">
                <div class="section">
                    <div class="title">打印</div>
                    <div class="section-content">
                        <div class="row clearfix mt10">
                            <div class="col-sm-12 col-md-12 column">
                                <button type="button" style="margin-top: 7px;" class="btn btn-primary btn-sm addJG btn-sm pull-right" onclick="jqprint();" >
                                    打印预览
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        </div>-->
    <!--弹出n拟稿权限提示的modal-->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">提示</h4>
                </div>
                <div class="modal-body">
                    您没有权限起草收文流程文档，请联系管理员。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="closeDailog()">关闭
                    </button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="grab_formTab_id" value="applicationForm,productDetails,resolution"/>
    <!--<input type="hidden" id="ctrlDivisionManager"  name="ctrlDivisionManager"/>-->
    <script type="text/javascript" src="../../../js/formUtils.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        function jqprint(){
            window.open("../../../bpm/print.do?readState="+[[${DATA_DOCUMENT_MODE}]]);
        }
        var filter_form_binding = ["requisition","details","resolution"];	//配置需要打包josn的form-binding属性节点 1 ，2界面绑定form-binding 以及bean-field
        var Deptobj;

        //附件类型添加
        function AttachmentUploaded() {
            if(_service.serviceCode=='OA-1057'&&_document.id!=''){
                $.ajax({
                    type: "post",
                    url: "../../../bpm/OA1057AttachmenAdd",
                    data: {documentId:_document.id},
                    dataType: "json",
                    success: function(data){
                        $("#attachmentType-list tbody tr").remove();
                        if(data!=null){
                            for(var i=0;i<data.length;i++){
                                attachmentTypelist(data,i);
                            }
                            $("#attachmentType-list tbody tr").each(function (index,e) {
                                var inputval=$(e).find("td").eq(2).find("input").val();
                                $(e).find("td").eq(2).find("select option[value='"+inputval+"']").prop("selected","selected");
                            });
                        }
                    }
                });
            }

        }
        //附件类型删除
        function AttachmentDeleted(fileId) {
            if(_service.serviceCode=='OA-1057'&&_document.id!=''){
                $("#attachmentType-list tbody tr").remove();
                $.ajax({
                    type: "post",
                    url: "../../../bpm/OA1057Attachmendelete",
                    data: {documentId:_document.id,id:fileId},
                    dataType: "json",
                    success: function(data){
                        if(data!=null){
                            for(var i=0;i<data.length;i++){
                                attachmentTypelist(data,i);
                            }
                            $("#attachmentType-list tbody tr").each(function (index,e) {
                                var inputval=$(e).find("td").eq(2).find("input").val();
                                $(e).find("td").eq(2).find("select option[value='"+inputval+"']").prop("selected","selected");
                            });
                        }
                    }
                });
            }

        }
        //附件类型渲染
        function attachmentTypelist(data,i) {
            var fileTypehtml="";
            if(_document_mode =='view'){
                var fileTypes = {"0":"产品图片","1":"产品公告","2":"法律文件","3":"交易指南","4":"分红信息","5":"单据下载",
                    "6":"产品合同","7":"集合资产管理业务风险提示书","8":"投资者申明与承诺","9":"产品说明书",
                    "10":"产品代销风险提示书","11":"理财产品电子签名约定书"};
                for(var ft in fileTypes){
                    if(ft==data[i]["fileType"]){
                        fileTypehtml=fileTypes[ft];
                        break;
                    }
                }
            }else{
                fileTypehtml='<select class="form-control span12" onchange="updateAttaType(this)"> ' +
                '<option value="">--Select--</option> ' +
                '<option value="0">产品图片</option> ' +
                '<option value="1">产品公告</option> ' +
                '<option value="2">法律文件</option> ' +
                '<option value="3">交易指南</option> ' +
                '<option value="4">分红信息</option> ' +
                '<option value="5">单据下载</option> ' +
                '<option value="6">产品合同</option> ' +
                '<option value="7">集合资产管理业务风险提示书</option> ' +
                '<option value="8">投资者申明与承诺</option> ' +
                '<option value="9">产品说明书</option> ' +
                '<option value="10">产品代销风险提示书</option> ' +
                '<option value="11">理财产品电子签名约定书</option> ' +
                '</select> ';
            }
            $("#attachmentType-list").append('<tr> <td>'+(i+1)+'</td> <td   name="fileName">'+data[i]["fileName"]+'</td> ' +
            '<td  name="fileType"> ' +
            '<input type="hidden" value="'+data[i]["fileType"]+'"/>'+fileTypehtml+
            '</td>' +
            '<td name="id" style="display: none;">'+data[i]["id"]+'</td>'+
            '<td name="documentId" style="display: none;">'+data[i]["documentId"]+'</td>'+
            '<td name="status" style="display: none;">'+data[i]["status"]+'</td>'+
            '<td name="createBy" style="display: none;">'+data[i]["createBy"]+'</td>'+
            '<td name="createDate" style="display: none;">'+data[i]["createDate"]+'</td>'+
            '<td name="updateBy" style="display: none;">'+data[i]["updateBy"]+'</td>'+
            '<td name="updateDate" style="display: none;">'+data[i]["updateDate"]+'</td>'+
            ' </tr>');
        }
        //附件类型修改
        function updateAttaType(obj){
            $.ajax({
                type: "post",
                url: "../../../bpm/OA1057AttachmenUpdate",
                data: {fileType:$(obj).val(),id:$(obj).parent().parent().find("td").eq(3).text()},
                dataType: "json",
                success: function(data){
                }
            });
        }
        function validate() {

            var isNum=0 ,isNum1=0,isNum2=0;
            $('#applicationForm .red').each(function(){
                isNum=0;
                if($(this).parent().next().find("input").length>0){
                    var tagType = $(this).parent().next().find("input").eq(0).attr("type");		//标签类型
                    if("radio"==tagType){
                        if($(this).parent().next().find("input").attr("name")=="fppIsType"){
                            if($(this).parent().parent().find("input[type='radio']:checked").val()==null){
                                alert($(this).parent().text().replace("*", "")+"为必选");
                                isNum=1;
                                $(this).parent().parent().find("input[type='radio']").focus();
                                return false;
                            }
                        }else{
                            if($(this).parent().next().find("input[type='radio']:checked").val()==null){
                                alert($(this).parent().text().replace("*", "")+"为必选");
                                isNum=1;
                                $(this).parent().next().find("input[type='radio']").focus();
                                return false;
                            }
                        }
                    }else if("checkbox" == tagType){
                        if($(this).parent().next().find("input[type='checkbox']:checked").val()==null){
                            alert($(this).parent().text().replace("*", "")+"为必选");
                            isNum=1;
                            $(this).parent().next().find("input[type='checkbox']").focus();
                            return false;
                        }
                    }else{
                        if($(this).parent().next().find("input[type='text']").val()==""){
                            alert($(this).parent().text().replace("*", "")+"为必填");
                            isNum=1;
                            $(this).parent().next().find("input[type='text']").focus();
                            return false;
                        }
                    }
                }else  if($(this).parent().next().find("select").length>0){
                    if($(this).parent().next().find("select option:selected").val()==null || $(this).parent().next().find("select option:selected").val()=="choose" ){
                        alert($(this).parent().text().replace("*", "")+"为必选");
                        isNum=1;
                        $(this).parent().next().find("select").focus();
                        return false;
                    }
                }else if($(this).parent().next().find("textarea").length>0){
                    if($(this).parent().next().find("textarea").val()==""){
                        alert($(this).parent().text().replace("*", "")+"为必填");
                        isNum=1;
                        $(this).parent().next().find("textarea").focus();
                        return false;
                    }
                }
            });
            if(isNum==1){
                $("#shenQLi").addClass("active").siblings('li').removeClass('active');
                $("#applicationForm").addClass("active").siblings('div').removeClass('active');
                return false;
            }
            $('#productDetails .red').each(function(){
                isNum1=0;
                if($(this).parent().next().find("input").length>0){
                    var tagType = $(this).parent().next().find("input").eq(0).attr("type");		//标签类型
                    if("radio"==tagType){
                        if($(this).parent().next().find("input[type='radio']:checked").val()==null){
                            alert($(this).parent().text().replace("*", "")+"为必选");
                            isNum1=1;
                            $(this).parent().next().find("input[type='radio']").focus();
                            return false;
                        }
                    }else if("checkbox" == tagType){
                        if($(this).parent().next().find("input[type='checkbox']:checked").val()==null){
                            alert($(this).parent().text().replace("*", "")+"为必选");
                            isNum1=1;
                            $(this).parent().next().find("input[type='checkbox']").focus();
                            return false;
                        }
                    }else{
                        if($(this).parent().next().find("input[type='text']").val()==""){
                            alert($(this).parent().text().replace("*", "")+"为必填");
                            isNum1=1;
                            $(this).parent().next().find("input[type='text']").focus();
                            return false;
                        }
                    }
                }else  if($(this).parent().next().find("select").length>0){
                    if($(this).parent().next().find("select option:selected").val()==null){
                        alert($(this).parent().text().replace("*", "")+"为必选");
                        isNum1=1;
                        $(this).parent().next().find("select").focus();
                        return false;
                    }
                }else if($(this).parent().next().find("textarea").length>0){
                    if($(this).parent().next().find("textarea").val()==""){
                        alert($(this).parent().text().replace("*", "")+"为必填");
                        isNum1=1;
                        $(this).parent().next().find("textarea").focus();
                        return false;
                    }
                }
            });
            if(isNum1==1){
                $("#chanPLi").addClass("active").siblings('li').removeClass('active');
                $("#productDetails").addClass("active").siblings('div').removeClass('active');
                return false;
            }



            if($("#scoreDiv .section").eq(0).css("display")=="block"){
                alert("请确认评分表!");
                $("#scoreDiv .section").eq(0).find("table tbody tr").eq(0).find("td input").focus();
                return false;
            }

            // 27打分
            if(_currentActivityId == "27"){
                // 发行人校验
                var fxrjy = null;
                $("input:checkbox[name='zhunruA']:checked").each(function(){
                    fxrjy = "OK";
                });
                if(fxrjy != "OK"){
                    if($("#zrscore1").val() == "" || $("#zrscore1").val() == " "){
                        alert("发行人准入情况和分数必填一项");
                        $("#zhunru1").focus();
                        return false;
                    }
                }
                // 投顾校验
                var tgjy = null;
                $("input:checkbox[name='zhunruB']:checked").each(function(){
                    tgjy = "OK";
                });
                if(tgjy != "OK"){
                    if($("#zrscore2").val() == "" || $("#zrscore2").val() == " "){
                        alert("投顾准入情况和分数必填一项");
                        $("#zhunru2").focus();
                        return false;
                    }
                }

            }

            // 当处理结果是不同意的时候，原因必填
            if (_currentActivityId == "02" || _currentActivityId == "10" || _currentActivityId == "31" || _currentActivityId == "40") {
                var approveResult = getApproveResult();
                if ((approveResult ==  "不同意" || approveResult ==  "退回补充") && $("#approveNote").val() ==  "") {
                    alert("您选择的结果为" + approveResult + "，请在意见栏中写明原因");
                    return false;
                }
            }else if(_currentActivityId == "12"||_currentActivityId == "27"){
                var inclass=$("#approveResult input:radio").attr("class");
                if(inclass!=undefined&&inclass!=null&&getApproveResult()==""){
                    alert("请在处理结果选择");
                    return false;
                }
                if( $("#approveNote").val() ==  ""){
                    alert("请在意见栏中说明原因");
                    return false;
                }
            }

            var tagname = $("#fppTitle").prop("nodeName");
            var Titleval = "INPUT"==tagname?$("#fppTitle").val():$("#fppTitle").text();
            var length = getTextLength(Titleval);
            if (length > 200) {
                alert("文档标题长度不得大于100个汉字，请修改标题。");
                $("#fppTitle").focus();
                return false;
            }
            //getFormFinanceJson();
            return true;
        }
        function doubleValidate(){
            if($("#nextActivities").val()=='26'){
            }else{
                var isNum2=0;
                $('#resolution .red').each(function(){
                    isNum2=0;
                    if($(this).parent().next().find("input").length>0){
                        var tagType = $(this).parent().next().find("input").eq(0).attr("type");		//标签类型
                        if("radio"==tagType){
                            if($(this).parent().next().find("input[type='radio']:checked").val()==null){
                                alert($(this).parent().text().replace("*", "")+"为必选");
                                isNum2=1;
                                $(this).parent().next().find("input[type='radio']").focus();
                                return false;
                            }
                        }else if("checkbox" == tagType){
                            if($(this).parent().next().find("input[type='checkbox']:checked").val()==null){
                                alert($(this).parent().text().replace("*", "")+"为必选");
                                isNum2=1;
                                $(this).parent().next().find("input[type='checkbox']").focus();
                                return false;
                            }
                        }else{
                            if($(this).parent().next().find("input[type='text']").val()==""){
                                alert($(this).parent().text().replace("*", "")+"为必填");
                                isNum2=1;
                                $(this).parent().next().find("input[type='text']").focus();
                                return false;
                            }
                        }
                    }else  if($(this).parent().next().find("select").length>0){
                        if($(this).parent().next().find("select option:selected").val()==null){
                            alert($(this).parent().text().replace("*", "")+"为必选");
                            isNum2=1;
                            $(this).parent().next().find("select").focus();
                            return false;
                        }
                    }else if($(this).parent().next().find("textarea").length>0){
                        if($(this).parent().next().find("textarea").val()==""){
                            alert($(this).parent().text().replace("*", "")+"为必填");
                            isNum2=1;
                            $(this).parent().next().find("textarea").focus();
                            return false;
                        }
                    }
                });
                $("#fengxianTab").find("tbody tr").each(function () {
                    $(this).find("td").each(function (index,e) {
                        var tdname=$(e).attr("name");
                        if(tdname!=undefined&&tdname!="undefined"){
                            if(tdname == "fppLevFen"){
                                if($(e).find("input").val() == "") {
                                    alert("风险等级评分为必选");
                                    isNum2=1;
                                    return false;
                                }
                            }
                        }
                    });
                });
                if(isNum2==1){
                    $("#JueYLi").addClass("active").siblings('li').removeClass('active');
                    $("#resolution").addClass("active").siblings('div').removeClass('active');
                    $("#dlg-submit").modal('hide');
                    return false;
                }


                if($("#nextActivities").val()=='886'&&$("#isPushdata").attr("name")!=undefined&&$("#isPushdata").attr("name")!="undefined"&&$("input[type='radio'][name='isPushdata']:checked").val()==null){
                    alert("是否要推送数据为必选");
                    $("input[type='radio'][name='isPushdata']").focus();
                    $("#dlg-submit").modal('hide');
                    return false;
                }
                //导入公示判定未选择 不允许提交
                /*if($("#nextActivities").val()=='886' && $("#isImprotPublicity").attr("name")!=undefined &&
                 $("#isImprotPublicity").attr("name")!="undefined" && $("input[type='radio'][name='isImprotPublicity']:checked").val()==null){
                 alert("是否导入公示必选");
                 $("input[type='radio'][name='isImprotPublicity']").focus();
                 $("#dlg-submit").modal('hide');
                 return false;
                 }*/
                /* if($("#nextActivities").val()=='886'){
                 if(checkImport()){
                 alert("还没导入公示");
                 return false;
                 }
                 }*/
            }
            return true;
        }
        function prepreData() {
            var tagname = $("#fppTitle").prop("nodeName");
            var Titleval = "INPUT"==tagname?$("#fppTitle").val():$("#fppTitle").text();
            var rc = true;
            rc = setDocumentTitle(Titleval);
            if (rc) rc = setDocumentData(getFormFinanceJson());
            return rc;
        }
        function binData() {
            var data = _document_data;
            // $("#ctrlDivisionManager").val(data.ctrlDivisionManager != undefined ? data.ctrlDivisionManager : "");

            if(data.isPushdata != null && data.isPushdata !=""){
                $("#isPushdata").parent().parent().html(showcheckradio("radio","isPushdata",data.isPushdata));
            }
            if(_document_mode == "process" && data.resolution != undefined){
                if(data.requisition["fppToType"] == "3" || data.requisition["fppToType"] == "4"){
                    data.requisition["fppToType"] == "1";
                }
            }
            //公示模块
            if(data.resolution == undefined){
                binFppNameChange(data.requisition,true);
            }else{
                binFppNameChange(data.resolution,false);
            }
            if(data.requisition != undefined){
                if(!data.requisition.hasOwnProperty("fppIsInvestCom")){
                    data.requisition["fppIsInvestCom"]="1";
                }
            }
            showRowToIdByJson(data.requisition,data);
            showRowToIdByJson(data.details,data);
            showRowToIdByJson(data.resolution,data);
            if(data.score!=null&&data.score!=""){
                $("#scoreDiv .section").eq(1).css("display","").siblings("#scoreDiv .section").css("display","none");
                showScaleData(data.score);
            }else{
                $("#scoreDiv .section").eq(0).css("display","").siblings("#scoreDiv .section").css("display","none");
            }
            if(_currentActivityId == '27' && _document_mode=="process"){
                $("#score27Div .section").eq(0).css("display","").siblings("#score27Div .section").css("display","none");
                showScore27Data(data.score27Data, "edit");
            }else if(data.score27Data != null && data.score27Data != ""){
                $("#score27Div .section").eq(0).css("display","none").siblings("#score27Div .section").eq(1).css("display","");
                showScore27Data(data.score27Data, "read");
            }else {
                $("#score27Div .section").eq(0).css("display", "none").siblings("#score27Div .section").eq(1).css("display", "none");
            }

            if(_currentActivityId == '13' || _currentActivityId == '14' || _currentActivityId == '32' || _currentActivityId == '37'){
                $("#JueYLi").addClass("active").siblings('li').removeClass('active');
                $("#resolution").addClass("active").siblings('div').removeClass('active');
            }

            $("#showStopLose").hide();
            if(data.details!= undefined){
                if(data.details.fppisStopLose != undefined){
                    if(data.details.fppisStopLose == '1'){
                        $("#showStopLose").show();
                    }
                }
            }
            if($("#showStopLose").css("display") == 'none'){
                $("#showStopLose").parent().removeClass("underline");
            }

        }
        function checkRequireSave() {
            if (_currentActivityId == '01'||_currentActivityId == '12'
                    ||_currentActivityId == '13'
                    ||_currentActivityId == '27'||_currentActivityId == '15'
                    ||_currentActivityId == '17'||_currentActivityId == '23'
                    ||_currentActivityId == '37'||_currentActivityId == '26') return true;
            else return false;
        }
        function renderNextActivities(nextActivities) {
            var newNextActivities = JSON.parse(JSON.stringify(nextActivities));

            // 拟稿下一处理步骤 20180907
            if(_currentActivityId == '01'){
                for(var i = 0; i < newNextActivities.length; i++){

                    if(newNextActivities[i].id == '02'){
                        newNextActivities[i].default = true;
                        newNextActivities[i].display = true;
                    }else{
                        newNextActivities[i].default = false;
                        newNextActivities[i].display = false;
                    }
                }
            }

            /* // 拟稿下一处理步骤
            if(_currentActivityId == '01'){
                var deptName = _currentUser.deptName;
                var orgType = _currentUser.orgType;
                if(orgType == '总部'){
                    for(var i = 0; i < newNextActivities.length; i++){ //总部默认走2

                        if(newNextActivities[i].id == '02'){
                            newNextActivities[i].default = true;
                            newNextActivities[i].display = true;
                        }else{
                            newNextActivities[i].default = false;
                            newNextActivities[i].display = false;
                        }
                    }
                    if(_currentUser.deptId == 'C3B6C8EDA11A87B648257F4C0024949B'){ // 同业与产品部
                        for(var i = 0; i < newNextActivities.length; i++){
                            if(newNextActivities[i].id == '34'){
                                newNextActivities[i].default = true;
                                newNextActivities[i].display = true;
                            }else{
                                newNextActivities[i].default = false;
                                newNextActivities[i].display = false;
                            }
                        }
                    }else if(_currentUser.deptId == '3BF7C833EAA806B248257B420028A5B7'){ //财富管理部
                        for(var i = 0; i < newNextActivities.length; i++){
                            if(newNextActivities[i].id == '38'){
                                newNextActivities[i].default = true;
                                newNextActivities[i].display = true;
                            }else{
                                newNextActivities[i].default = false;
                                newNextActivities[i].display = false;
                            }
                        }
                    }else{
                        // 按默认，不处理
                    }
                }else if(orgType == '分支机构'){
                    if(deptName.indexOf('营业部') >= 0){ // 营业部
                        for(var i = 0; i < newNextActivities.length; i++){
                            if(newNextActivities[i].id == '03'){

                                newNextActivities[i].default = true;
                                newNextActivities[i].display = true;
                            }else{
                                newNextActivities[i].default = false;
                                newNextActivities[i].display = false;
                            }
                        }
                    }else { // 分公司
                        for(var i = 0; i < newNextActivities.length; i++){
                            if(newNextActivities[i].id == '04'){
                                newNextActivities[i].default = true;
                                newNextActivities[i].display = true;
                            }else{
                                newNextActivities[i].default = false;
                                newNextActivities[i].display = false;
                            }
                        }
                    }
                }else if(orgType == '子公司'){
                    for(var i = 0; i < newNextActivities.length; i++){
                        if(newNextActivities[i].id == '35'){
                            newNextActivities[i].default = true;
                            newNextActivities[i].display = true;
                        }else{
                            newNextActivities[i].default = false;
                            newNextActivities[i].display = false;
                        }
                    }
                }else{ // 其他
                    for(var i = 0; i < newNextActivities.length; i++){
                        if(newNextActivities[i].id == '2'){
                            newNextActivities[i].default = true;
                            newNextActivities[i].display = true;
                        }else{
                            newNextActivities[i].default = false;
                            newNextActivities[i].display = false;
                        }
                    }
                }
            }*/

            // 部门负责人审核步骤(02节点不采用)
            if ( _currentActivityId == '02') {
                for (var i=0; i<newNextActivities.length; i++) {
                    if (newNextActivities[i].reportChain.length > 0) {
                        if(newNextActivities[i].id=='02'){
                            newNextActivities[i].display = true;
                            newNextActivities[i].default = true;
                            break;
                        }
                    }else{
                        if(newNextActivities[i].id=='09'){
                            newNextActivities[i].display = true;
                            newNextActivities[i].default = true;
                        }
                    }
                }
            }
            if ( _currentActivityId == '26'|| _currentActivityId == '27'|| _currentActivityId == '28'|| _currentActivityId == '29'|| _currentActivityId == '33') {
//                var recordSize=$("#audit-record-content table").eq(1).find("tbody tr").length;
                var lastId;
                if(_device=="mobile"){
                    $("#audit-record-content .mb-timeline").find("li").each(function (index,item) {
                        for(var i = 0; i < newNextActivities.length; i++){
                            if(newNextActivities[i].id == $(this).find("input").eq(0).val()){
                                lastId = newNextActivities[i].id;
                                break;
                            }
                        }
                    });
                }else{
                    $("#audit-record-content table").eq(1).find("tbody tr").each(function (index,item) {
                        for(var i = 0; i < newNextActivities.length; i++){
                            if(newNextActivities[i].id == $(this).find("td").eq(0).text()){
                                lastId = newNextActivities[i].id;
                                break;
                            }
                        }
                    });
                }
                for(var i = 0; i < newNextActivities.length; i++){
                    if(newNextActivities[i].id == lastId){
                        newNextActivities[i].default = true;
                        newNextActivities[i].display = true;
                    }else{
                        newNextActivities[i].default = false;
                        newNextActivities[i].display = false;
                    }
                }

            }
            defaultRenderNextActivities(newNextActivities);
        }
        function openSelectProvideDeptDlg(obj) {
            Deptobj=obj;
            openSelectDeptDlg(true,30,deptDlgGetdata,deptDlgCallback);
        }
        function deptDlgGetdata(obj) {
            var names = $(Deptobj).parent().prev().val();
            var codes = $(Deptobj).parent().prev().prev().val();
            var ids = $(Deptobj).parent().prev().prev().prev().val();
            var depts = [];
            var splitted = names.split(',');
            var splittedcodes = codes.split(',');
            var splittedids = ids.split(',');
            for (var i=0; i<splitted.length; i++) {
                var name = splitted[i];
                var code=splittedcodes[i];
                var id=splittedids[i];
                if (name != "") {
                    var dept = {deptName: name, deptId: id,deptCode:code};
                    depts.push(dept);
                }
            }
            return JSON.stringify(depts);
        }
        function deptDlgCallback(depts) {
            var names = "";
            var codes="";
            var ids="";
            for (var i=0; i<depts.length; i++) {
                if (i > 0){
                    names += ",";
                    codes+=",";
                    ids+=",";
                }
                names += depts[i].deptName;
                codes += depts[i].deptCode;
                ids+=depts[i].deptId;
            }
            $(Deptobj).parent().prev().val(names);
            $(Deptobj).parent().prev().prev().val(codes);
            $(Deptobj).parent().prev().prev().prev().val(ids);
        }
        $(document).ready(function() {
//            $("[data-toggle='popover']").popover();
            pie_props.onValidate = validate;
            pie_props.onPrepareDocumentData = prepreData;
            pie_props.onRenderNextActivities = renderNextActivities;
            pie_props.onCheckRequireSave = checkRequireSave;
            pie_props.onAttachmentUploaded = AttachmentUploaded;
            pie_props.onAttachmentDeleted = AttachmentDeleted;
            pie_props.onDoubleValidate = doubleValidate;
            pie_props.onPrint = jqprint;
            AttachmentUploaded();
            initializeForm();

            //加载产品类型
            loadPublicityType();

            binData();
            conferenceBtn();
            //   _category = "ExtractZipFile";

            isAllowDraft();//是否允许进行拟稿
        });
        var type,type1,type2;
        function loadPublicityType(){
            var uri = "../../../bpm/OA1057PublicityClasslist";
            $.ajax({
                type: "GET",
                url: uri,
                async: false,
//                contentType: 'application/x-www-form-urlencoded;charset=UTF-8',
                dataType: "json",
                success: function (json) {
                    type = json.type;
                    type1 = json.type1;
                    type2 = json.type2;
                    $("#publicity_type").children().remove();
                    $("#publicity_type").append("<option value = 'choose'>请选择</option>");

                    $("#fpp_publicity_type").children().remove();
                    $("#fpp_publicity_type").append("<option value = 'choose'>请选择</option>");
                    for (var i in type) {
                        $("#publicity_type").append("<option value=" + type[i].id + ">" + type[i].typeName + "</option>");
                        $("#fpp_publicity_type").append("<option value=" + type[i].id + ">" + type[i].typeName + "</option>");
                    }
                }
            });
            /*$("#publicity_type").click(function(){
             alert("xuanzeleixing~");

             });*/
        }
        function nameChange(){
            var typeValue = $('#publicity_type option:selected').attr('value');

            var values,abreast;
            for(var i in type1){
                if(i == typeValue){
                    values = type1[i];
                    break;
                }
            }
            for(var i in type2){
                if(i == typeValue){
                    abreast = type2[i];
                    break;
                }
            }
            if(values != undefined){
                $("#publicity_type1").children().remove();
                $("#publicity_type1").attr("style", "");
                for(var j = 0; j < values.length; j++){
                    $("#publicity_type1").append("<option value=" + values[j].id + ">" + values[j].typeName + "</option>");
                }
            }else{
                $("#publicity_type1").attr("style", "display:none");
            }
            if(abreast != undefined){
                $("#publicity_type2").children().remove();
                $("#publicity_type2").attr("style", "");
                for(var j = 0; j < abreast.length; j++){
                    $("#publicity_type2").append("<option value=" + abreast[j].id + ">" + abreast[j].typeName + "</option>");
                }
            }else{
                $("#publicity_type2").attr("style", "display:none");
            }
        }
        function fppNameChange(){
            var typeValue = $('#fpp_publicity_type option:selected').attr('value');

            var values,abreast;
            for(var i in type1){
                if(i == typeValue){
                    values = type1[i];
                    break;
                }
            }
            for(var i in type2){
                if(i == typeValue){
                    abreast = type2[i];
                    break;
                }
            }
            if(values != undefined){
                $("#fpp_publicity_type1").children().remove();
                $("#fpp_publicity_type1").attr("style", "");
                for(var j = 0; j < values.length; j++){
                    $("#fpp_publicity_type1").append("<option value=" + values[j].id + ">" + values[j].typeName + "</option>");
                }
            }else{
                $("#fpp_publicity_type1").attr("style", "display:none");
            }
            if(abreast != undefined){
                $("#fpp_publicity_type2").children().remove();
                $("#fpp_publicity_type2").attr("style", "");
                for(var j = 0; j < abreast.length; j++){
                    $("#fpp_publicity_type2").append("<option value=" + abreast[j].id + ">" + abreast[j].typeName + "</option>");
                }
            }else{
                $("#fpp_publicity_type2").attr("style", "display:none");
            }
        }
        function binFppNameChange(json,isfrist){
            if(json != undefined){
                if(isfrist){
                    $("#fpp_publicity_type").find("option[value = '" + json["publicity_type"] + "']").attr("selected", true);
                    fppNameChange();
                    if(json["publicity_type1"] != null || json["publicity_type1"] != undefined ){
                        $("#fpp_publicity_type1").attr("style", "");
                        $("#fpp_publicity_type1 option").each(function () {
                            $("#fpp_publicity_type1").find("option[value = '" + json["publicity_type1"] + "']").attr("selected", true);
                        });
                    }
                    if(json["publicity_type2"] != null || json["publicity_type2"] != undefined){
                        $("#fpp_publicity_type2").attr("style", "");
                        $("#fpp_publicity_type2 option").each(function () {
                            $("#fpp_publicity_type2").find("option[value = '" + json["publicity_type2"] + "']").attr("selected", true);
                        });
                    }
                    if(json["moneyRiskLv"] != null || json["moneyRiskLv"] != undefined){
                        $('input[type="radio"][name="fppMoneyRiskLv"] ').each(function () {
                            if($(this).val()==json["moneyRiskLv"]){
                                $(this).attr("checked",'checked');
                            }
                        });
                    }
                }else{
                    $("#fpp_publicity_type").find("option[value = '" + json["fpp_publicity_type"] + "']").attr("selected", true);
                    fppNameChange();
                    if(json["fpp_publicity_type1"] != null || json["fpp_publicity_type1"] != undefined ){
                        $("#fpp_publicity_type1").attr("style", "");
                        $("#fpp_publicity_type1 option").each(function () {
                            $("#fpp_publicity_type1").find("option[value = '" + json["publicity_type1"] + "']").attr("selected", true);
                        });
                    }
                    if(json["fpp_publicity_type2"] != null || json["fpp_publicity_type2"] != undefined){
                        $("#fpp_publicity_type2").attr("style", "");
                        $("#fpp_publicity_type2 option").each(function () {
                            $("#fpp_publicity_type2").find("option[value = '" + json["publicity_type2"] + "']").attr("selected", true);
                        });
                    }
                }
            }
        }
        function getFormFinanceJson(){
            var json   =   {};
            $.each($("div"),function(){
                var form_binding = $(this).attr("form-binding");
                if($.inArray(form_binding, filter_form_binding) > -1){
                    json[form_binding] = getDataByFromNodeAndBeanFile($(this));
                }
            });
            json["score"]=getScaleData();
            // json["ctrlDivisionManager"]=$("#ctrlDivisionManager").val();

            if($("#nextActivities").val()=='886'){
                json["isPushdata"]=$("input[type='radio'][name='isPushdata']:checked").val();
            }
            json["score27Data"] = getScore27View();
            console.log(JSON.stringify(json));
            console.log(json);
            // return JSON.stringify(json);
            //公示模块

            /* json["publicityTypeText"]=$("#publicity_type").find("option:selected").text();
             json["publicityTypeText1"]=$("#publicity_type1").find("option:selected").text();
             json["publicityTypeText2"]=$("#publicity_type2").find("option:selected").text();*/
            return json;
        }
        /**
         * 18-3-28新增是否投顾机构
         * */
        $("input[type='radio'][name='fppIsInvestCom']").click(function(){
            var inverstRadio = $("input[type='radio'][name='fppIsInvestCom']:checked").val();
            if(inverstRadio == "1"){
                $("#showInvestCom").html('投顾机构<span style="color:red" class="red">*</span>');
                $("#showInvest").show();
            }else if(inverstRadio == "2"){
                $("#showInvestCom").html('投顾机构');
                $("#showInvest").hide();

            }
        });

        /**
         * 根据根节点div获取绑定name属性的数据
         * @param fromNode	xxxx==$(this).attr("form-binding")  =>  $(this)
         * @return JSON
         */
        function getDataByFromNodeAndBeanFile(fromNode){
            var obj = {};
            fromNode.find("*").each(function(index,e){
                // e === 原生对象；$(e) === jq 对象
                var bean_field = $(e).attr("name");
                var data_unjson= $(e).attr("data-unjson");	//过滤掉被form-binding包裹但不需要打包的数据
                if(typeof(bean_field)!="undefined" && typeof(data_unjson)=="undefined") {
                    obj[bean_field] = getValueByNode($(e),"|");
                }
            });
            return obj;
        }
        /**
         * 根据节点获取对应的值
         * @param  node节点 选中的节点元素 ＝> $(this) || $('#xxxx') || $('.xxxx') || .....
         * @param  separator 分割符号   如:checkbox返回一串指定分割的string  1,2,3,4,5  ','即为分割符号
         */
        function getValueByNode(node,separator){
            var tag = $(node).prop("nodeName");	//标签名
            if( "INPUT"  == tag){
                var tagType = $(node).attr("type");		//标签类型
                if("radio"==tagType){
                    var radio_value = $('input[type="'+tagType+'"][name="'+node.context.name+'"]:checked ').val();
                    //var radio_value = $('input[type="'+tagType+'"][name="'+node.context.name+'"]:checked ').next().text();
                    return radio_value==undefined?"":radio_value;
                }else if("checkbox" == tagType){
                    var checkbox_value = "";
                    $('input[type="'+tagType+'"][name="'+node.context.name+'"]:checked ').each(function(index,item){
                        checkbox_value += $(item).val()+separator;
                        //checkbox_value += $(item).next().text()+separator;
                    });
                    return checkbox_value==undefined?"":checkbox_value;
                }else{
                    return node.val();
                }
            }else if("SELECT" == tag){

                return node.val();
                // return $(node).find("option:selected").text();
            }else if("TEXTAREA" == tag){
                return node.val();
            }else if("TABLE"==tag){
                var tabInfo = [];
                $(node).find("tbody tr").each(function () {
                    var obj = {};
                    $(this).find("td").each(function (index,e) {
                        // alert($(e).find('input[type="checkbox"][name="'+tdname+'"]:checked ').val());
                        var tdname=$(e).attr("name");
                        if(tdname!=undefined&&tdname!="undefined"){
                            var tdval="";
                            if($(e).find("input").val()!=undefined&&$(e).find("input").val()!="undefined") {
                                if($(e).find('input[type="checkbox"][name="'+tdname+'"]').val() != undefined){
                                    $(e).find('input[type="checkbox"][name="'+tdname+'"]:checked ').each(function(index,item){
                                        tdval += $(item).parent().find("span").text()+separator;
                                    });
                                    tdval = tdval.substring(0,tdval.lastIndexOf("|"));
                                }else{
                                    tdval=$(e).find("input").val();
                                }
                            }else if($(e).find("select option:selected").val()!=undefined&&$(e).find("select option:selected").val()!="undefined"){
                                tdval=$(e).find("select option:selected").val();
                            }else{
                                tdval=$(e).text();
                            }
                            obj[tdname]=tdval;
                        }
                    });
                    tabInfo.push(obj);
                });
                return tabInfo;
            }else{
                if( $(node).next().find("input").attr("name")!=undefined&& $(node).next().find("input").attr("name")!=""){
                    var tagType=$(node).next().find("input").attr("type");
                    var inputName= $(node).next().find("input").attr("name");
                    if("radio"==tagType){
                        return getcheckradio(tagType,inputName,node.text());
                    }else if("checkbox" == tagType){
                        return getcheckradio(tagType,inputName,node.text());
                    }
                }else if( $(node).next().find("select").attr("name")!=undefined&& $(node).next().find("select").attr("name")!=""){
                    var selNum=0;
                    var fppNum=$("input[type='radio'][name='fppClass']:checked ").val();
                    if(fppNum=="1"){
                        selNum=0;
                    }else if(fppNum=="2"){
                        selNum=1;
                    }else if(fppNum=="3"){
                        selNum=2;
                    }
                    if($(node).attr("name")=="fppProductType"||$(node).attr("name")=="fppStyle"){
                        return $(node).next().find("select").eq(selNum).find("option:selected").val();
                    }else{
                        return $(node).next().find("select option:selected").val();
                    }
                }else{
                    return node.html().replace(/<br\/?>/ig,"\n").replace(/&nbsp;/ig," ");
                }
            }
            return $.trim(node.text());
        }
        /**
         * 回显一条数据到各个对应id的节点上
         * @param JSON  => {max:"1",min:"0",xxx:"133",......}  key为id
         */
        function showRowToIdByJson(JSON,dataJsonArry){
            for(var id in JSON){
                var node    = $("#"+id);		//节点
                var tag 	= $("#"+id).prop("nodeName");	//标签名
                // 根据历史数据有值，则隐藏客户适当性要素新增投资品种和的客户投资风险表格，显示风险等级checkbox历史数据，添加必填*标志
                if (JSON["customerLev"] != undefined && JSON["customerLev"] != "undefined" && JSON["customerLev"] != "") {
                    $("#custFppToType").attr("style", "display:none");
                    $("#custFppToType").find('span[class="red"]').each(function (index, item) {
                        $(item).attr("class","");
                    });
                    if ($("#customerAddfengXianTabBtn") != undefined) {
                        $("#customerAddfengXianTabBtn").attr("style", "display:none");
                    }
                    $("#customerFengxianTab").attr("style", "display:none");
                    $("#customerFengxianTab").find("i").each(function (index, item) {
                        $(item).text("");
                    });
                    $("#custLev").attr("style", "display:display");
                    $("#custLev").find('span[class="red"]').each(function (index, item) {
                        $(item).text("*");
                    });
                }
                if( "INPUT"  == tag ){
                    var tagType = $("#"+id).attr("type");		//标签类型
                    var inputName= $(node).attr("name");  //name名称
                    if("radio"==tagType){
                        checkradio(tagType,inputName,JSON[id]);
                    }else if("checkbox" == tagType){
                        checkradio(tagType,inputName,JSON[id]);
                    }else{
                        node.val(JSON[id]);
                    }
                }else if( "SELECT" == tag ){
                    /* $("#productDetails").find("div").each(function () {
                     if($(this).attr("form-binding")){

                     }
                     });*/
                    if(dataJsonArry["requisition"]["fppClass"]=="1"){
                        $("#tzTd").html('投资风格<span style="color:red" class="red">*</span>');
                        $("select[name='fppProductType']").eq(0).attr("id","fppProductType").siblings("select[name='fppProductType']").removeAttr("id");
                        $("select[name='fppProductType']").eq(0).removeAttr("data-unjson").siblings("select[name='fppProductType']").attr("data-unjson","1");
                        $("select[name='fppProductType']").eq(0).css("display","").siblings("select[name='fppProductType']").css("display","none");
                        $("select[name='fppStyle']").eq(0).attr("id","fppStyle").siblings("select[name='fppStyle']").removeAttr("id");
                        $("select[name='fppStyle']").eq(0).removeAttr("data-unjson").siblings("select[name='fppStyle']").attr("data-unjson","1");
                        $("select[name='fppStyle']").eq(0).css("display","").siblings("select[name='fppStyle']").css("display","none");
                    }else if(dataJsonArry["requisition"]["fppClass"]=="2"){
                        $("#tzTd").html('收益类型<span style="color:red" class="red">*</span>');
                        $("select[name='fppProductType']").eq(1).attr("id","fppProductType").siblings("select[name='fppProductType']").removeAttr("id");
                        $("select[name='fppProductType']").eq(1).removeAttr("data-unjson").siblings("select[name='fppProductType']").attr("data-unjson","1");
                        $("select[name='fppProductType']").eq(1).css("display","").siblings("select[name='fppProductType']").css("display","none");
                        $("select[name='fppStyle']").eq(1).attr("id","fppStyle").siblings("select[name='fppStyle']").removeAttr("id");
                        $("select[name='fppStyle']").eq(1).removeAttr("data-unjson").siblings("select[name='fppStyle']").attr("data-unjson","1");
                        $("select[name='fppStyle']").eq(1).css("display","").siblings("select[name='fppStyle']").css("display","none");
                    }else if(dataJsonArry["requisition"]["fppClass"]=="3"){
                        $("#tzTd").html('投资风格<span style="color:red" class="red">*</span>');
                        $("select[name='fppProductType']").eq(2).attr("id","fppProductType").siblings("select[name='fppProductType']").removeAttr("id");
                        $("select[name='fppProductType']").eq(2).removeAttr("data-unjson").siblings("select[name='fppProductType']").attr("data-unjson","1");
                        $("select[name='fppProductType']").eq(2).css("display","").siblings("select[name='fppProductType']").css("display","none");
                        $("select[name='fppStyle']").eq(2).attr("id","fppStyle").siblings("select[name='fppStyle']").removeAttr("id");
                        $("select[name='fppStyle']").eq(2).removeAttr("data-unjson").siblings("select[name='fppStyle']").attr("data-unjson","1");
                        $("select[name='fppStyle']").eq(2).css("display","").siblings("select[name='fppStyle']").css("display","none");
                    }
                    if(dataJsonArry["requisition"]["publicity_type"] != null || dataJsonArry["requisition"]["publicity_type"] != undefined || dataJsonArry["requisition"]["publicity_type"] != ""){
                        //新增公示模块类型
                        $("#publicity_type").find("option[value = '" + dataJsonArry["requisition"]["publicity_type"] + "']").attr("selected", true);
                        nameChange();
                    }
                    if(dataJsonArry["requisition"]["publicity_type1"] != null || dataJsonArry["requisition"]["publicity_type1"] != undefined || dataJsonArry["requisition"]["publicity_type1"] != "" ){
                        // $("#publicity_type1").attr("style", "");
                        $("#publicity_type1 option").each(function () {
                            $("#publicity_type1").find("option[value = '" + dataJsonArry["requisition"]["publicity_type1"] + "']").attr("selected", true);
                        });
                    }
                    if(dataJsonArry["requisition"]["publicity_type2"] != null || dataJsonArry["requisition"]["publicity_type2"] != undefined || dataJsonArry["requisition"]["publicity_type2"] != ""){
                        $("#publicity_type2").attr("style", "");
                        $("#publicity_type2 option").each(function () {
                            $("#publicity_type2").find("option[value = '" + dataJsonArry["requisition"]["publicity_type2"] + "']").attr("selected", true);
                        });
                    }
                    if(dataJsonArry["resolution"] != undefined){
                        if(dataJsonArry["resolution"]["fpp_publicity_type"] != null || dataJsonArry["resolution"]["fpp_publicity_type"] != undefined || dataJsonArry["resolution"]["fpp_publicity_type"] !=""){
                            $("#fpp_publicity_type").find("option[value = '" + dataJsonArry["resolution"]["publicity_type"] + "']").attr("selected", true);
                            fppNameChange();
                        }
                        if(dataJsonArry["resolution"]["fpp_publicity_type1"] != null || dataJsonArry["resolution"]["fpp_publicity_type1"] != undefined || dataJsonArry["resolution"]["fpp_publicity_type1"] != ""){
                            $("#fpp_publicity_type1").attr("style", "");
                            $("#fpp_publicity_type1 option").each(function () {
                                $("#fpp_publicity_type1").find("option[value = '" + dataJsonArry["resolution"]["fpp_publicity_type1"] + "']").attr("selected", true);
                            });
                        }
                        if(dataJsonArry["resolution"]["fpp_publicity_type2"] != null || dataJsonArry["resolution"]["fpp_publicity_type2"] != undefined || dataJsonArry["resolution"]["fpp_publicity_type2"] != ""){
                            $("#fpp_publicity_type2").attr("style", "");
                            $("#publicity_type2 option").each(function () {
                                $("#fpp_publicity_type2").find("option[value = '" + dataJsonArry["resolution"]["fpp_publicity_type2"] + "']").attr("selected", true);
                            });
                        }
                    }

                    // $("#"+id+" option[value='"+JSON[id]+"']").prop("selected","selected");

                    $("#"+id+" option").each(function(i,item){
                        if ($(this).val() == JSON[id]) {
                            $(this).attr('style','');
                            $(this).attr('selected', true);
                            $(this).prop('selected', true);
                            return false;
                        }
                    });

                }else if( "TEXTAREA"==tag ){
                    node.val(JSON[id]);
                }else if( "TABLE"==tag ){
                    var tabarray=JSON[id];
                    var tharry = [];
                    $(node).find("thead th").each(function () {
                        // if($(this).attr("name")!=undefined&&$(this).attr("name")!=""){
                        tharry.push($(this).attr("name"));
                        // }
                    });
                    $(node).find("tbody").html("");
                    for(var i=0;i<tabarray.length;i++){
                        var time = new Date().getTime();
                        var trhtml="<tr>";
                        if($(node).attr("name")=="rateTab"){
                            trhtml="<tr id=\"" + time + "\" class=\"unjson\">";
                        }
                        for(var thname in tharry){
                            for(var tbname in tabarray[i]){
                                if(tharry[thname]==tbname){
                                    if($(node).attr("name")=="fengxianTab"&&$.inArray("delete", tharry) > -1){
                                        if(tbname=="fenE"){
                                            trhtml+="<td data-unjson='1' name='"+tbname+"'><input type='text' id='"+tbname+i+"'  data-unjson='1' class='form-control' value='"+tabarray[i][tbname]+"'/></td>";
                                            break;
                                        }else if(tbname=="fppLevFen"){
                                            trhtml+="<td data-unjson='1' name='"+tbname+"'><input type='text' id='"+tbname+i+"'  data-unjson='1' class='form-control' value='"+tabarray[i][tbname]+"'/><span style='display: none;'>"+tabarray[i][tbname]+"</span></td>";
                                            break;
                                        }else if(tbname=="fppRiLev"){
                                            var sel1="",sel2="",sel3="",sel4="", sel5="";
                                            if(tabarray[i][tbname]==1){
                                                sel1='selected="selected"';
                                            }else  if(tabarray[i][tbname]==2){
                                                sel2='selected="selected"';
                                            }else  if(tabarray[i][tbname]==3){
                                                sel3='selected="selected"';
                                            }else if(tabarray[i][tbname]==4){
                                                sel4='selected="selected"';
                                            }else if(tabarray[i][tbname]==5){
                                                sel5='selected="selected"';
                                            }
                                            trhtml+="<td data-unjson='1' name='"+tbname+"'><select id='fppRiLev' data-unjson='1' class='form-control'> " +
                                            "<option value='1' "+sel1+">低风险</option> " +
                                            "<option value='2' "+sel2+">较低风险</option> " +
                                            "<option value='3' "+sel3+">中风险</option> " +
                                            "<option value='4' "+sel4+">较高风险</option> " +
                                            "<option value='5' "+sel5+">高风险</option> " +
                                            "</select></td>";
                                            break;
                                        }else if(tbname=="fppToterm"){
                                            var sel1="",sel2="",sel3="",sel4="",sel0="";
                                            if(tabarray[i][tbname]==1){
                                                sel1='selected="selected"';
                                            }else  if(tabarray[i][tbname]==2){
                                                sel2='selected="selected"';
                                            }else if(tabarray[i][tbname]==3){
                                                sel3='selected="selected"';
                                            }else if(tabarray[i][tbname]==4){
                                                sel4='selected="selected"';
                                            }else if(tabarray[i][tbname]==0){
                                                sel0='selected="selected"';
                                            }
                                            trhtml+="<td data-unjson='1' name='"+tbname+"'><select id='fppToterm' data-unjson='1' class='form-control'> " +
                                            "<option value='1' "+sel1+">短期（1年以内）</option> " +
                                            "<option value='2' "+sel2+">中期（1-3年）</option> " +
                                            "<option value='3' "+sel3+">中长期（3-5年）</option> " +
                                            "<option value='4' "+sel4+">长期（5年及以上）</option> " +
                                                /*"<option value='5' "+sel2+">期限不限</option> " +*/
                                            "</select></td>";
                                            break;
                                        }
                                    }// 客户适当性表格数据回显begin
                                    else if($(node).attr("name")=="customerFengxianTab"&&$.inArray("delete", tharry) > -1){
                                        if(tbname=="customerFenE"){
                                            trhtml+="<td data-unjson='1' name='"+tbname+"'><input type='text' id='"+tbname+i+"'  data-unjson='1' class='form-control' value='"+tabarray[i][tbname]+"'/></td>";
                                            break;
                                        }else if(tbname=="customerFppLev"){
                                            var sel1="",sel2="",sel3="",sel4="", sel5="",sel6="",sel7="",sel8="";
                                            if(tabarray[i][tbname] != undefined && tabarray[i][tbname] != "undefined" && tabarray[i][tbname] !="") {
                                                var customerArry = tabarray[i][tbname].split("|");
                                                for (var customerFppLev in customerArry) {
                                                    if (customerArry[customerFppLev] == 1) {
                                                        sel1 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 2) {
                                                        sel2 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 3) {
                                                        sel3 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 4) {
                                                        sel4 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 5) {
                                                        sel5 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 6) {
                                                        sel6 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 7) {
                                                        sel7 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 8) {
                                                        sel8 = 'checked="checked"';
                                                    }
                                                }
                                            }
                                            trhtml+="<td data-unjson='1' name='"+tbname+"'>" +
                                                "<label class='checkbox-inline' style='display: block;margin-left: 10px;'><input type='checkbox' id='customerFppLev' name='customerFppLev' value='1' "+sel1+"><span>特别保护型</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppLev' value='2' "+sel2+"/><span>保守型</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppLev' value='3' "+sel3+"/><span>谨慎型</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppLev' value='4' "+sel4+"/><span>稳健型</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppLev' value='5' "+sel5+"/><span>积极型</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppLev' value='6' "+sel6+"/><span>进取型</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppLev' value='7' "+sel7+"/><span>专业投资者</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppLev' value='8' "+sel8+"/><span>专业机构投资者</span></label>" +
                                                "</td>";
                                            break;
                                        }else if(tbname=="customerFppToterm"){
                                            var sel1="",sel2="",sel3="",sel4="";
                                            if(tabarray[i][tbname] != undefined && tabarray[i][tbname] != "undefined" && tabarray[i][tbname] !="") {
                                                var customerArry = tabarray[i][tbname].split("|");
                                                for (var customerFppLev in customerArry) {
                                                    if (customerArry[customerFppLev] == 1) {
                                                        sel1 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 2) {
                                                        sel2 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 3) {
                                                        sel3 = 'checked="checked"';
                                                    } else if (customerArry[customerFppLev] == 4) {
                                                        sel4 = 'checked="checked"';
                                                    }
                                                }
                                            }
                                            trhtml+="<td data-unjson='1' name='"+tbname+"'>" +
                                                "<label class='checkbox-inline' style='display: block;margin-left: 10px;'><input type='checkbox' id='customerFppToterm' name='customerFppToterm' value='1' "+sel1+"><span>短期（1年以内）</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppToterm' value='2' "+sel2+"/><span>中期（3年以内）</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppToterm' value='3' "+sel3+"/><span>中长期（5年以内）</span></label>" +
                                                "<label class='checkbox-inline' style='display: block;'><input type='checkbox' name='customerFppToterm' value='4' "+sel4+"/><span>期限不限</span></label>" +
                                                "</td>";
                                            break;
                                        }
                                    }
                                    // 客户适当性表格数据回显end
                                    else{
                                        if($(node).attr("name")=="managerTab"&&tbname=="mChiName"){
                                            trhtml+="<td data-unjson='1' name='"+tbname+"' style='cursor: pointer;color: blue;' onclick='slectMangerDetail(this)'>"+tabarray[i][tbname]+"</td>"
                                        }else{
                                            // 将checkbox数据由数字转换成对应文字回显
                                            var tbvalue = tabarray[i][tbname];
                                            if($(node).attr("name")=="customerFengxianTab" && tbname !="customerFenE" ){
                                                var tbvalJson = {"1customerFppLev":"特别保护型","2customerFppLev":"保守型","3customerFppLev":"谨慎型","4customerFppLev":"稳健型",
                                                                 "5customerFppLev":"积极型","6customerFppLev":"进取型","7customerFppLev":"专业投资者","8customerFppLev":"专业机构投资者",
                                                                 "1customerFppToterm":"短期（1年以内）","2customerFppToterm":"中期（3年以内）","3customerFppToterm":"中长期（5年以内）","4customerFppToterm":"期限不限"
                                                };
                                                if(tbvalue != undefined && tbvalue != "undefined" && tbvalue !="") {
                                                    var tbvalarray = tbvalue.split("|");
                                                    var temptbvlue = "";
                                                    for(var tbv in tbvalarray){
                                                        if(tbvalJson[tbvalarray[tbv]+tbname] != undefined && tbvalJson[tbvalarray[tbv]+tbname] != "undefine"){
                                                            temptbvlue += tbvalJson[tbvalarray[tbv]+tbname]+"|";
                                                        }
                                                    }
                                                    tbvalue = temptbvlue.substring(0,temptbvlue.lastIndexOf("|"));
                                                }
                                            }
                                            trhtml+="<td data-unjson='1' name='"+tbname+"'>"+tbvalue+"</td>"
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        if($.inArray("delete", tharry) > -1){
                            if($(node).attr("name")=="rateTab"){
                                trhtml+="<td><span style='color: red;cursor: pointer;' onclick=\"delRateRow(this,'" + time + "')\">删除 </span><span style='cursor: pointer;' class='showRateRow' onclick='showRateRow(this)'>| 修改</span></td></tr>";
                            }else{
                                trhtml+="<td style='color: red; cursor: pointer;' onclick='delNode(this)'>删除</td></tr>";
                            }
                        }else{
                            trhtml+="<td style='display:none;'></td></tr>";
                        }
                        $(node).append(trhtml);
                    }
                    if($(node).attr("name")=="fengxianTab"&&$.inArray("delete", tharry) > -1){
                        $(node).find("tbody tr").each(function (index,item) {
                            $(this).find("td[name='fppLevFen']").find("input").val($(this).find("td[name='fppLevFen']").find("span").text());
                            $("input[id='fppLevFen"+index+"']").val($(this).find("td[name='fppLevFen']").find("span").text());
                        });
                    }else if($(node).attr("name")=="fengxianTab"){
                        var fppRiLev = {"1":"低风险","2":"较低风险","3":"中风险","4":"较高风险","5":"高风险"};
                        var fppToterm = {"1":"短期（1年以内）","2":"中期（1-3年）","3":"中长期（3-5年）","4":"长期（5年及以上）"};
                        $(node).find("tbody tr").each(function (index,item) {
                            for(var ft in fppRiLev){
                                if(ft==$(this).find("td[name='fppRiLev']").text()){
                                    $(this).find("td[name='fppRiLev']").html("<input type='hidden'  data-unjson='1' class='form-control' value='"+ft+"'/>"+fppRiLev[ft]);
                                    break;
                                }
                            }
                            for(var ft in fppToterm){
                                if(ft== $(this).find("td[name='fppToterm']").text()){
                                    $(this).find("td[name='fppToterm']").html("<input type='hidden'  data-unjson='1' class='form-control' value='"+ft+"'/>"+fppToterm[ft]);
                                    break;
                                }
                            }
                        });
                    }
                }
                else{//文本<div></div> || <span></span> || .....
                    if( $(node).next().find("input").attr("name")!=undefined&& $(node).next().find("input").attr("name")!=""){
                        var tagType=$(node).next().find("input").attr("type");
                        var inputName= $(node).next().find("input").attr("name");
                        if("radio"==tagType){
                            node.text(showcheckradio(tagType,inputName,JSON[id],JSON));
                        }else if("checkbox" == tagType){
                            node.text(showcheckradio(tagType,inputName,JSON[id],JSON));
                        }
                    }else if( $(node).next().find("select").attr("name")!=undefined&& $(node).next().find("select").attr("name")!=""){
                        var selNum=0;
                        if(dataJsonArry["requisition"]["fppClass"]=="1"){
                            $("#tzTd").html('投资风格<span style="color:red" class="red">*</span>');
                            selNum=0;
                        }else if(dataJsonArry["requisition"]["fppClass"]=="2"){
                            $("#tzTd").html('收益类型<span style="color:red" class="red">*</span>');
                            selNum=1;
                        }else if(dataJsonArry["requisition"]["fppClass"]=="3"){
                            $("#tzTd").html('投资风格<span style="color:red" class="red">*</span>');
                            selNum=2;
                        }
                        if($(node).attr("name")=="fppProductType"||$(node).attr("name")=="fppStyle"){
                            $(node).next().find("select").eq(selNum).find("option").each(function () {
                                if( $(this).val()==JSON[id]){
                                    $(this).attr('selected', true);
                                    node.text($(this).text());
                                    return false;
                                }
                            });
                        }else{
                            $(node).next().find("select option").each(function () {
                                if( $(this).val()==JSON[id]){
                                    $(this).attr('selected', true);
                                    node.text($(this).text());
                                    return false;
                                }
                            });
                        }
                    }else{
                        //node.html(node.text(JSON[id]).html().split("\n").join("<br />"));
                        if(id == "publicity_type"){
                            for(var i in type){
                                if(type[i].id == JSON[id]){
                                    node.attr("style","display:none");
                                    node.html(node.text(type[i].id).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                    $("#publicity_type_name").html($("#publicity_type_name").text(type[i].typeName).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                }
                            }
                        }else if(id == "publicity_type1"){
                            for(var i in type1){
                                for(var j in type1[i]){
                                    if(type1[i][j].id == JSON[id]){
                                        node.attr("style","display:none");
                                        node.html(node.text(type1[i][j].id).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                        $("#publicity_type1_name").html($("#publicity_type1_name").text(type1[i][j].typeName).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                    }
                                }
                            }
                        }else if(id == "publicity_type2"){
                            for(var i in type2){
                                for(var j in type2[i]){
                                    if(type2[i][j].id == JSON[id]){
                                        node.attr("style","display:none");
                                        node.html(node.text(type2[i][j].id).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                        $("#publicity_type2_name").html($("#publicity_type2_name").text(type2[i][j].typeName).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                    }
                                }
                            }
                        }else if(id == "fpp_publicity_type"){
                            for(var i in type){
                                if(type[i].id == JSON[id]){
                                    node.attr("style","display:none");
                                    node.html(node.text(type[i].id).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                    $("#fpp_publicity_type_name").html($("#fpp_publicity_type_name").text(type[i].typeName).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                }
                            }
                        }else if(id == "fpp_publicity_type1"){
                            for(var i in type1){
                                for(var j in type1[i]){
                                    if(type1[i][j].id == JSON[id]){
                                        node.attr("style","display:none");
                                        node.html(node.text(type1[i][j].id).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                        $("#fpp_publicity_type1_name").html($("#fpp_publicity_type1_name").text(type1[i][j].typeName).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                    }
                                }
                            }
                        }else if(id == "fpp_publicity_type2"){
                            for(var i in type2){
                                for(var j in type2[i]){
                                    if(type2[i][j].id == JSON[id]){
                                        node.attr("style","display:none");
                                        node.html(node.text(type2[i][j].id).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                        $("#fpp_publicity_type2_name").html($("#fpp_publicity_type2_name").text(type2[i][j].typeName).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                                    }
                                }
                            }
                        }else{
                            if(node.text(JSON[id]).html() != undefined){
                                node.html(node.text(JSON[id]).html().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;"));
                            }
                        }
                    }
                }
            }
        }


        function  getcheckradio(tagType,name,textval) {
            var textVal="";
            if("radio"==tagType){
                textVal= $('input[type="'+tagType+'"][name="'+name+'"]:checked ').val();
            }else if("checkbox" == tagType){
                if(textval!=undefined&&textval!=""){
                    $('input[type="'+tagType+'"][name="'+name+'"]:checked ').each(function(index,item){
                        textVal += $(item).val()+"|";
                    });
                    if(name=="inlineCheckbox"&&$("input[type='text'][name='otherSalesChannels']").val()!=""){
                        textVal+="6|"
                    }
                    textVal=textVal.substring(0,textVal.lastIndexOf("|"));
                }
            }
            return textVal;
        }
        function  showcheckradio(tagType,name,value,JSON) {
            var textVal="";
            if("radio"==tagType){
                if(name =="fppIsInvestCom"){
                    if(value =="" || value == undefined){
                        value ="1";
                    }
                    if(value == "2"){
                        $("#showInvestCom").html('投顾机构');
                        $("#showInvest").hide();
                    }
                }
                $('input[type="'+tagType+'"][name="'+name+'"] ').each(function () {
                    if($(this).val()==value){
                        $(this).attr("checked",'checked');
                        textVal= $(this).next().text();
                        return false;
                    }
                });
            }else if("checkbox" == tagType){
                if(value!=undefined&&value!=""){
                    var arrayVal=value.split("|");
                    for(var i=0;i<arrayVal.length;i++){
                        $('input[type="'+tagType+'"][name="'+name+'"] ').each(function () {
                            if($(this).val()==arrayVal[i]){
                                $(this).attr("checked",'checked');
                                textVal+= $(this).next().text()+"|";
                                return false;
                            }
                        });
                    }
                    if(name=="inlineCheckbox"&&$.inArray("6", arrayVal) > -1){
                        textVal+=JSON["otherSalesChannels"]+"|"
                    }
                    textVal=textVal.substring(0,textVal.lastIndexOf("|"));
                }
            }
            return textVal;
        }


        function  checkradio(tagType,name,value) {
            if("radio"==tagType){
                if(name =="fppIsInvestCom"){
                    if(value =="" || value == undefined){
                        value ="1";
                    }
                    if(value == "2"){
                        $("#showInvestCom").html('投顾机构');
                        $("#showInvest").hide();
                    }
                }
                $('input[type="'+tagType+'"][name="'+name+'"] ').each(function () {
                    /* if($(this).next().text()==value){
                     $(this).attr("checked",'checked');
                     return false;
                     }*/
                    if($(this).val()==value){
                        $(this).attr("checked",'checked');
                        return false;
                    }
                });
            }else if("checkbox" == tagType){
                if(value!=undefined&&value!=""){
                    var arrayVal=value.split("|");
                    for(var i=0;i<arrayVal.length;i++){
                        $('input[type="'+tagType+'"][name="'+name+'"] ').each(function () {
                            /*if($(this).next().text()==arrayVal[i]){
                             $(this).attr("checked",'checked');
                             return false;
                             }*/
                            if($(this).val()==arrayVal[i]){
                                $(this).attr("checked",'checked');
                                return false;
                            }
                        });
                        if(name=="inlineCheckbox"&&arrayVal[i]==6){
                            $('#otherSalesChannels').attr("disabled",false);
                        }
                    }
                }
            }
        }

        function delNode(obj) {
            $(obj).parent().remove();
        }


        function getScaleData() {
            var tabInfo = [];
            $("#scoreDiv .section").eq(1).find("table tbody tr").each(function () {
                var obj = {};
                $(this).find("td").each(function (i,e) {
                    var tdname=$(e).attr("name");
                    if(tdname!=undefined&&tdname!="undefine"){
                        var tdval="";
                        if($(e).find("input").val()!=undefined&&$(e).find("input").val()!="undefine"){
                            tdval=$(e).find("input").val();
                        }else if($(e).find("select option:selected").val()!=undefined&&$(e).find("select option:selected").val()!="undefine"){
                            tdval=$(e).find("select option:selected").val();
                        }else{
                            tdval=$(e).text();
                        }
                        obj[tdname]=tdval;
                    }
                });
                tabInfo.push(obj);
            });
            return tabInfo;
        }

        function getScore27View(){
            var zhunru1 = $('input:checkbox[name="zhunruA"]:checked').val()!=undefined?$('input:checkbox[name="zhunruA"]:checked').val():" " ;
            var zrscore1 = $("#zrscore1").val() != "" ? $("#zrscore1").val() : " ";
            var zhunru23 = $('input:checkbox[name="zhunruB"]:checked').val()!=undefined?$('input:checkbox[name="zhunruB"]:checked').val():" " ;
            var zrscore2 = $("#zrscore2").val() != "" ? $("#zrscore2").val() : " ";
            var documentId27 = $("#documentId27").text();
            var taskId27 = $("#taskId27").text();
            var activityId27 = $("#activityId27").text();
            var currentuserCode27 = $("#currentuserCode27").text();
            var currentuserName27 = $("#currentuserName27").text();
            var score27 = {
                fxrzhunru : zhunru1,
                fxrscore : zrscore1,
                tgzhunru : zhunru23,
                tgscore : zrscore2,
                documentId : documentId27,
                taskId : taskId27,
                activityId : activityId27,
                currentuserCode : currentuserCode27,
                currentuserName : currentuserName27
            }

            return score27;

        }

        function showScore27Data(jsonArry, flag){
            var tharry = [];
            $("#score27Div .section").eq(1).find("table thead th").each(function () {
                if($(this).css("display")!="none"){
                    tharry.push($(this).attr("name"));
                }
            });
            if(flag == "read"){
                // 解析准入表决只读列表
                if(jsonArry != ""){
                    for(var i = 0; i < jsonArry.length; i++) {
                        var Scaltime = new Date().getTime();
                        var trhtml = "<tr class='' id='" + Scaltime + "'>";
                        for (var thname in tharry) {
                            for (var tname in jsonArry[i]) {
                                if(tharry[thname]==tname){
                                    if(tname == "fxrzhunru"){ //发行人准入
                                        if(jsonArry[i][tname] == "1"){
                                            trhtml += "<td class='col-md-1'   name='" + tname + "'>" + "已准入" + "</td>";
                                            break;
                                        }else{
                                            trhtml += "<td class='col-md-1'   name='" + tname + "'>" + jsonArry[i][tname] + "</td>";
                                            break;
                                        }
                                    }else if(tname == "tgzhunru"){ // 投顾准入
                                        if(jsonArry[i][tname] == "2"){
                                            trhtml += "<td class='col-md-1'   name='" + tname + "'>" + "已准入" + "</td>";
                                            break;
                                        }else if(jsonArry[i][tname] == "3"){
                                            trhtml += "<td class='col-md-1'   name='" + tname + "'>" + "不适应" + "</td>";
                                            break;
                                        }else{
                                            trhtml += "<td class='col-md-1'   name='" + tname + "'>" + jsonArry[i][tname] + "</td>";
                                            break;
                                        }
                                    }else{ // 分数直接显示
                                        trhtml += "<td class='col-md-1'   name='" + tname + "'>" + jsonArry[i][tname] + "</td>";
                                        break;
                                    }

                                }
                            }
                        }
                        trhtml+="</tr>";
                        $("#score27Div .section").eq(1).find("table").append(trhtml);
                    }
                }
            }

            if(flag == "edit"){
                // 解析准入表决编辑表单
                if(jsonArry != ""){
                    for(var i = 0; i < jsonArry.length; i++){
                        if(jsonArry[i]["currentuserCode"] == _currentUserId ){ // 取自己的记录
                            var fxrzhunru = jsonArry[i]["fxrzhunru"];
                            $("input:checkbox[name='zhunruA']").each(function(){
                                if($(this).val()==fxrzhunru){
                                    $(this).attr("checked",'checked');
                                    $("#zrscore1").attr("disabled",true);
                                    return false;
                                }
                            });
                            $("#zrscore1").val(jsonArry[i]["fxrscore"]);
                            var tgzhunru = jsonArry[i]["tgzhunru"];
                            $("input:checkbox[name='zhunruB']").each(function(){
                                if($(this).val()==tgzhunru){
                                    $(this).attr("checked",'checked');
                                    $("#zrscore2").attr("disabled", true);
                                    return false;
                                }
                            });
                            $("#zrscore2").val(jsonArry[i]["tgscore"]);
                            break;
                        }
                    }
                }
            }
        }

        function showScaleData(jsonArry) {
            var tharry = [];
            $("#scoreDiv .section").eq(1).find("table thead th").each(function () {
                tharry.push($(this).attr("name"));
            });
            if(_currentActivityId!='12'&&_currentActivityId!='27'||_document_mode =='view'){
                $("#scoreDiv .section").eq(1).find("table thead th[name='CaoZuo']").css("display","none");
            }
            for(var i=0;i<jsonArry.length;i++){
                var Scaltime = new Date().getTime();
                var trhtml="<tr class='row' id='"+Scaltime+"'>";
                var cuserName="",scoreSum=0;
                for(var thname in tharry){
                    for(var tbname in jsonArry[i]){
                        if(tharry[thname]==tbname&&tharry[thname]=="currentuserCode"){
                            trhtml+="<td class='col-md-1'  style='display: none;' name='"+tbname+"'>"+jsonArry[i][tbname]+"</td>";
                            break;
                        }else if(tharry[thname]==tbname&&tharry[thname]=="documentId"){
                            trhtml+="<td class='col-md-1'  style='display: none;' name='"+tbname+"'>"+jsonArry[i][tbname]+"</td>";
                            break;
                        }else if(tharry[thname]==tbname&&tharry[thname]=="taskId"){
                            trhtml+="<td class='col-md-1'  style='display: none;' name='"+tbname+"'>"+jsonArry[i][tbname]+"</td>";
                            break;
                        }else if(tharry[thname]==tbname&&tharry[thname]=="activityId"){
                            trhtml+="<td class='col-md-1'  style='display: none;' name='"+tbname+"'>"+jsonArry[i][tbname]+"</td>";
                            break;
                        }else if(tharry[thname]==tbname&&tharry[thname]=="id"){
                            trhtml+="<td class='col-md-1'  style='display: none;' name='"+tbname+"'>"+jsonArry[i][tbname]+"</td>";
                            break;
                        }else if(tharry[thname]==tbname){
                            if(tbname=="sum"){
                                scoreSum=jsonArry[i][tbname];
                            }else if(tbname=="currentuserName"){
                                cuserName=jsonArry[i][tbname];
                            }
                            trhtml+="<td class='col-md-1' name='"+tbname+"'>"+jsonArry[i][tbname]+"</td>";
                            break;
                        }
                    }
                }
                if($.inArray("CaoZuo", tharry) > -1&&_currentActivityId=='12'&&!(_document_mode =='view')||$.inArray("CaoZuo", tharry) > -1&&_currentActivityId=='27'&&!(_document_mode =='view')){
                    trhtml+="<td class='col-md-1'><span style='color: red;cursor: pointer;' onclick='scoreHeJiTabBtnFun(this);'>修改</span></td></tr>";
                }else{
                    trhtml+="<td class='col-md-1' style='display:none;'></td></tr>";
                }
                $("#scoreDiv .section").eq(1).find("table").append(trhtml);
                $(".zhured").append("<span id='"+Scaltime+"span'>"+isScoreTabSpan(cuserName,scoreSum)+"</span><br/>");
            }
            if(_document_data.requisition != undefined){
                if(!_document_data.requisition.hasOwnProperty("fppIsInvestCom")){
                    $("#touZiTab1").attr("disabled",false);
                }else{
                    if(_document_data.requisition["fppIsInvestCom"] == "2"){
                        if(_document_data.requisition["fppType"] == "2"){
                            $("#touZiTab1").attr("style","display:none");
                        }else{
                            $("#touZiTab2").attr("style","display:none");
                        }
                    }
                }
            }
        }

        function isScoreTabSpan(currentuserName,num){
            var fengLev,touziType;      //风险等级，投资类型
            if(num>=90){
                fengLev = "低风险";
                touziType = "保守型投资者";
            }else if(num>=80 && num<90){
                fengLev = "较低风险";
                touziType = "谨慎型投资者";
            }else if(num>=70 && num<80){
                fengLev = "中风险";
                touziType = "稳健型投资者";
            }else if(num>=60 && num<70){
                fengLev = "较高风险";
                touziType = "积极型投资者";
            }else if(num<60){
                fengLev = "高风险";
                touziType = "进取型投资者";
            }
            var html = "评审委员："+currentuserName+"，评估总分值："+num+"，风险等级："+fengLev+"，适销投资者类型："+touziType;
            return html;
        }

        //判断只能输入整数或浮点数
        function CheckInputIntFloat(oInput) {
            if('' != oInput.value.replace(/\d{1,}\.{0,1}\d{0,}/,''))
            {
                oInput.value = oInput.value.match(/\d{1,}\.{0,1}\d{0,}/) == null ? '' :oInput.value.match(/\d{1,}\.{0,1}\d{0,}/);
            }
        }
        /*
         * 展示推送
         * */
        function showPushResult() {
            ModalOpenView("推送结果","myPushResultModal-table-template",initpushResult,null);
        }
        function initpushResult() {
            $.ajax({
                url: "../../../bpm/rest/service/OA-1057/showPushResult",
                data: {'documentId': _document.id, 'params': '1'},
                type: "POST",
                dataType: 'json',
                success: function (data) {
                    $('#ModalCommonview .modal-body .list-group').empty();
                    if (data) {
                        if( data.data && data.data.length>0) {
                            for (var i = 0; i < data.data.length; i++) {
                                $('#ModalCommonview .modal-body .list-group').append("<li class='list-group-item'>【"+(i+1)+"】" + data.data[i].linkInfo + "</li>");
                            }
                        }else{
                            $('#ModalCommonview .modal-body .list-group').append("<li class='list-group-item'><center>暂无数据！！</center></li>");
                        }
                        //$('#myPushResultModal').modal('show');
                    } else {
                        alert("查看推送结果失败");
                    }
                }
            });
        }
        /*]]>*/
        /* function testDownLoad(){
         var documentId = $("#pie_document_id").val();
         var taskId = $("#pie_task_id").val();
         var service = $("#pie_service_code").val();
         $.ajax({
         type:"get",
         url:'/bpm/OA1057TestDownLoad',
         data:{documentId:documentId,taskId:taskId,service:service,device : _device}
         });
         window.location.href="../../../bpm/OA1057TestDownLoad?documentId="+documentId+"&taskId="+taskId;
         }*/
        function conferenceBtn(){
            /* if( _currentActivityId == "17" && _document_mode == "process" ||
             _currentActivityId == "20" && _document_mode == "process"||
             _currentActivityId == "23" && _document_mode == "process"){
             $(".navbar-inner").find(".container").prepend("<a class=\"btn btn-warning\" onclick='importPublicity()' id=\"ewBtn\" style='float: left'><span class=\"glyphicon glyphicon-eye-open\"></span>导入评审公示</a>");
             }*/
            if(_document.status == "closed"){
                $.ajax({
                    type:"post",
                    url: "../../../bpm/getPublicityManager",
                    data:{documentId: _document.id},
                    dataType: "json",
                    success: function (json) {
                        if(json.isScopePublicity){
                            if(json.isSuperAuthority){
                                $(".navbar-inner").find(".container").prepend("<a class=\"btn btn-warning\" onclick='importPublicity()' id=\"ewBtn\" style='float: left'><span class=\"glyphicon glyphicon-eye-open\"></span>导入评审公示</a>");
                            }else{
                                if(json.isAuthority && !json.isImportPublicity){
                                    $(".navbar-inner").find(".container").prepend("<a class=\"btn btn-warning\" onclick='importPublicity()' id=\"ewBtn\" style='float: left'><span class=\"glyphicon glyphicon-eye-open\"></span>导入评审公示</a>");
                                }
                            }
                        }
                    }
                });
            }
        }
        function importPublicity(){
            /* $.ajax({
             type:"post",
             url: "../../../bpm/importPublicityMain",
             data:{documentId:_document.id,ischecked:false},
             async: false,
             dataType: "json",
             success: function (json) {
             if(json.result){
             if(json.ischecked){
             importParam();
             }else{
             var re = confirm("数据已经入导入，再次导入会覆盖原先的数据");
             if(re){
             importParam();
             }
             }
             }
             }
             });*/
            isImportPublicityClick();
        }
        function importParam(){
            $.ajax({
                type:"post",
                url: "../../../bpm/importPublicityMain",
                data:{documentId:_document.id,ischecked:true},
                async: false,
                dataType: "json",
                success: function (json) {
                    if(json.result){
                        alert("导入完成");
                    }else{
                        alert("导入失败,"+json.msg);
                    }
                }
            });
        }
        /**
         * 验证是否已经导入
         */
        function checkImport(){
            var checkImport = false;
            $.ajax({
                type:"post",
                url: "../../../bpm/importPublicityMain",
                data:{documentId:_document.id,ischecked:false},
                async: false,
                dataType: "json",
                success: function (json) {
                    if(json.result){
                        if(json.ischecked){
                            checkImport = true;
                        }else{
                            checkImport = false;
                        }
                    }
                }
            });
            return checkImport;
        }
        ////-------------------------------------------------
        var setting = {
            data: {
                simpleData: {
                    enable: true
                }
            },
            check: {
                enable: true,
                nocheckInherit: false
            },
            view: {
                selectedMulti: false

            },
            callback: {
                onClick:function(e, id, node){
                    var zTree = $.fn.zTree.getZTreeObj("publicityTree");
                    if(node.isParent) {
                        zTree.expandNode();
                    } else {
                        addTabs(node.name, node.file);
                    }
                },
                onCheck:function(e, id, node){
                    alert("选中了");
                    var zTree = $.fn.zTree.getZTreeObj("publicityTree");
                    var nodes = zTree.getCheckedNodes(true);
                    for(var i=0;i<nodes.length;i++){
                        alert(nodes[i].name);
                    }
                }
            }
        };
        function isImportPublicityClick(){
            var zNodes =[];
            /* zNodes[0] ={id:'1', pId:'0', name:'test1', open:true};
             zNodes[1] ={id:'2', pId:'1', name:'test2'};
             zNodes[2] ={id:'3', pId:'1', name:'test3'};
             zNodes[3] ={id:'4', pId:'0', name:'test4',open:true};*/
            $.ajax({
                type:"post",
                url: "../../../bpm/getAttachmentAllByTree",
                data:{documentId:_document.id},
                async: false,
                dataType: "json",
                success: function (json) {
                    if(json.success){
                        zNodes = json.rows;
                    }else{
                        alert(json.msg);
                    }
                }
            });

            initPublicityResult(zNodes);

            $("#showTree").show();

        }
        function publicityCancel(){
            $("#showTree").hide();
        }
        function publicitySuccess(){
            //alert($('#publicityTree').treeview('getChecked')) ;
            var param = "";
            var params = $('#publicityTree').treeview('getChecked');
            for(var i in params){
                if(param != ""){
                    param+=","+params[i].id ;
                }else{
                    param =  params[i].id ;
                }

            }
            $.ajax({
                data:{param:param,documentId:_document.id},
                url:"../../../bpm/importPublicityMain",
                type:"post",
                dataType: "json",
                success:function(json){
                    if(json.result){
                        alert("导入成功!");
                    }else{
                        alert("导入失败!");
                    }
                }
            });
            $("#showTree").hide();
        }
        function initPublicityResult(zNodes){
            /* $.fn.zTree.init($("#publicityTree"), setting, zNodes);
             $.fn.zTree.getZTreeObj("publicityTree");*/
            $('#publicityTree').treeview({
                data:zNodes,
                showCheckbox :true,
                showIcon : true,
                showBorder :false
            });
        }
        function clickNode(target){
            var nodeid = $(target).attr('data-nodeid');
            var tree = $('#publicityTree');
            //获取当前节点对象
            var node = tree.treeview('getNode', nodeid);
            $("#dlg-zipMessage").hide();
            if(node.nodes != undefined){
                if(node.nodes.length >0){
                    /*var r = confirm("是否重复解压");
                     if(r){
                     $("#dlg-zipMessage").show();
                     extractZipLine(node.id,true);
                     }*/
                }else{
                    $("#dlg-zipMessage").show();
                    extractZipLine(node.id,false);
                }
            }
        }
        function extractZipLine(fileId,repetition){
            $.ajax({
                data:{fileId:fileId,repetition:repetition},
                url:"../../../bpm/getExtractZipLine",
                type:"post",
                dataType: "json",
                success:function(json){
                    $("#dlg-zipMessage").hide();
                    if(json.httpCode == "200"){
                        isImportPublicityClick();
                    }else{
                        alert("解压失败请联系管理员");
                    }
                }
            });
        }

        /*
        * 是否允许进行拟稿（屏蔽非总部用户拟稿权限）
        * */
        function isAllowDraft() {
            if (_document.status == "draft") {
                if (_currentActivityId == "01") {
                    var orgType = _currentUser.orgType;
                    if(orgType != '总部'){
                        $('#exampleModal').modal('show');
                    }
                }
            }
        }

        /*
         * 关闭模态框
         * */
        function closeDailog() {
            $('#exampleModal').modal('hide');
        }

        /*
         * 关闭当前窗体
         * */
        function CloseWebPage() {
            if (navigator.userAgent.indexOf("MSIE") > 0) {
                if (navigator.userAgent.indexOf("MSIE 6.0") > 0) {
                    window.opener = null;
                    window.close();
                } else {
                    window.open('', '_top');
                    window.top.close();
                }
            }
            else if (navigator.userAgent.indexOf("Firefox") > 0) {
                window.location.href = 'about:blank ';
            } else {
                window.opener = null;
                window.open('', '_self', '');
                window.close();
            }
        }

        //关闭模态框回调
        $('#exampleModal').on('hide.bs.modal', function () {
            CloseWebPage();
        });
    </script>
    <div class="modal" id="showTree" style="display: none;" tabindex="1" role="dialog" data-backdrop="static" aria-labelledby="dlg-select-flow-label" >
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="width: 670px;">
                <div class="modal-header">
                    <h4 class="modal-title" id="dlg-begin-flow-label">导入公示</h4>
                </div>
                <div  class="modal-body"  style="height: 350px;overflow-y: auto;">
                    <ul id="publicityTree"><!-- class="ztree"-->
                    </ul>
                </div>
                <div class="modal-footer">
                    <div class="row" style="margin: 0px;">
                        <button type="button" id="dlg-begin-publicity-cancel" class="btn btn-default" data-dismiss="modal" onclick="publicityCancel()">取消</button>
                        <button type="button" id="dlg-begin-publicity-success" class="btn btn-default" data-dismiss="modal" onclick="publicitySuccess()">完成</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="dlg-zipMessage" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="zipMessageModalLabel">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-body" >
                    <div id="zipMessageModalContent" style="text-align: center" class="mt10">压缩包解压中......</div>
                    <div class="progress mt10">
                        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                            <span class="sr-only">处理中</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</html>